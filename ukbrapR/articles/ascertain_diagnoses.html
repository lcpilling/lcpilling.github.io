<!DOCTYPE html>

<html>

<head>

<meta charset="utf-8" />
<meta name="generator" content="pandoc" />
<meta http-equiv="X-UA-Compatible" content="IE=EDGE" />

<meta name="viewport" content="width=device-width, initial-scale=1" />



<title>Ascertaining UK Biobank diagnoses</title>

<script>// Pandoc 2.9 adds attributes on both header and div. We remove the former (to
// be compatible with the behavior of Pandoc < 2.8).
document.addEventListener('DOMContentLoaded', function(e) {
  var hs = document.querySelectorAll("div.section[class*='level'] > :first-child");
  var i, h, a;
  for (i = 0; i < hs.length; i++) {
    h = hs[i];
    if (!/^h[1-6]$/i.test(h.tagName)) continue;  // it should be a header h1-h6
    a = h.attributes;
    while (a.length > 0) h.removeAttribute(a[0].name);
  }
});
</script>

<style type="text/css">
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
span.underline{text-decoration: underline;}
div.column{display: inline-block; vertical-align: top; width: 50%;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
</style>



<style type="text/css">
code {
white-space: pre;
}
.sourceCode {
overflow: visible;
}
</style>
<style type="text/css" data-origin="pandoc">
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
{ counter-reset: source-line 0; }
pre.numberSource code > span
{ position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
{ content: counter(source-line);
position: relative; left: -1em; text-align: right; vertical-align: baseline;
border: none; display: inline-block;
-webkit-touch-callout: none; -webkit-user-select: none;
-khtml-user-select: none; -moz-user-select: none;
-ms-user-select: none; user-select: none;
padding: 0 4px; width: 4em;
color: #aaaaaa;
}
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa; padding-left: 4px; }
div.sourceCode
{ }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } 
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } 
code span.at { color: #7d9029; } 
code span.bn { color: #40a070; } 
code span.bu { color: #008000; } 
code span.cf { color: #007020; font-weight: bold; } 
code span.ch { color: #4070a0; } 
code span.cn { color: #880000; } 
code span.co { color: #60a0b0; font-style: italic; } 
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } 
code span.do { color: #ba2121; font-style: italic; } 
code span.dt { color: #902000; } 
code span.dv { color: #40a070; } 
code span.er { color: #ff0000; font-weight: bold; } 
code span.ex { } 
code span.fl { color: #40a070; } 
code span.fu { color: #06287e; } 
code span.im { color: #008000; font-weight: bold; } 
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } 
code span.kw { color: #007020; font-weight: bold; } 
code span.op { color: #666666; } 
code span.ot { color: #007020; } 
code span.pp { color: #bc7a00; } 
code span.sc { color: #4070a0; } 
code span.ss { color: #bb6688; } 
code span.st { color: #4070a0; } 
code span.va { color: #19177c; } 
code span.vs { color: #4070a0; } 
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } 
</style>
<script>
// apply pandoc div.sourceCode style to pre.sourceCode instead
(function() {
  var sheets = document.styleSheets;
  for (var i = 0; i < sheets.length; i++) {
    if (sheets[i].ownerNode.dataset["origin"] !== "pandoc") continue;
    try { var rules = sheets[i].cssRules; } catch (e) { continue; }
    var j = 0;
    while (j < rules.length) {
      var rule = rules[j];
      // check if there is a div.sourceCode rule
      if (rule.type !== rule.STYLE_RULE || rule.selectorText !== "div.sourceCode") {
        j++;
        continue;
      }
      var style = rule.style.cssText;
      // check if color or background-color is set
      if (rule.style.color === '' && rule.style.backgroundColor === '') {
        j++;
        continue;
      }
      // replace div.sourceCode by a pre.sourceCode rule
      sheets[i].deleteRule(j);
      sheets[i].insertRule('pre.sourceCode{' + style + '}', j);
    }
  }
})();
</script>




<style type="text/css">body {
background-color: #fff;
margin: 1em auto;
max-width: 700px;
overflow: visible;
padding-left: 2em;
padding-right: 2em;
font-family: "Open Sans", "Helvetica Neue", Helvetica, Arial, sans-serif;
font-size: 14px;
line-height: 1.35;
}
#TOC {
clear: both;
margin: 0 0 10px 10px;
padding: 4px;
width: 400px;
border: 1px solid #CCCCCC;
border-radius: 5px;
background-color: #f6f6f6;
font-size: 13px;
line-height: 1.3;
}
#TOC .toctitle {
font-weight: bold;
font-size: 15px;
margin-left: 5px;
}
#TOC ul {
padding-left: 40px;
margin-left: -1.5em;
margin-top: 5px;
margin-bottom: 5px;
}
#TOC ul ul {
margin-left: -2em;
}
#TOC li {
line-height: 16px;
}
table {
margin: 1em auto;
border-width: 1px;
border-color: #DDDDDD;
border-style: outset;
border-collapse: collapse;
}
table th {
border-width: 2px;
padding: 5px;
border-style: inset;
}
table td {
border-width: 1px;
border-style: inset;
line-height: 18px;
padding: 5px 5px;
}
table, table th, table td {
border-left-style: none;
border-right-style: none;
}
table thead, table tr.even {
background-color: #f7f7f7;
}
p {
margin: 0.5em 0;
}
blockquote {
background-color: #f6f6f6;
padding: 0.25em 0.75em;
}
hr {
border-style: solid;
border: none;
border-top: 1px solid #777;
margin: 28px 0;
}
dl {
margin-left: 0;
}
dl dd {
margin-bottom: 13px;
margin-left: 13px;
}
dl dt {
font-weight: bold;
}
ul {
margin-top: 0;
}
ul li {
list-style: circle outside;
}
ul ul {
margin-bottom: 0;
}
pre, code {
background-color: #f7f7f7;
border-radius: 3px;
color: #333;
white-space: pre-wrap; 
}
pre {
border-radius: 3px;
margin: 5px 0px 10px 0px;
padding: 10px;
}
pre:not([class]) {
background-color: #f7f7f7;
}
code {
font-family: Consolas, Monaco, 'Courier New', monospace;
font-size: 85%;
}
p > code, li > code {
padding: 2px 0px;
}
div.figure {
text-align: center;
}
img {
background-color: #FFFFFF;
padding: 2px;
border: 1px solid #DDDDDD;
border-radius: 3px;
border: 1px solid #CCCCCC;
margin: 0 5px;
}
h1 {
margin-top: 0;
font-size: 35px;
line-height: 40px;
}
h2 {
border-bottom: 4px solid #f7f7f7;
padding-top: 10px;
padding-bottom: 2px;
font-size: 145%;
}
h3 {
border-bottom: 2px solid #f7f7f7;
padding-top: 10px;
font-size: 120%;
}
h4 {
border-bottom: 1px solid #f7f7f7;
margin-left: 8px;
font-size: 105%;
}
h5, h6 {
border-bottom: 1px solid #ccc;
font-size: 105%;
}
a {
color: #0033dd;
text-decoration: none;
}
a:hover {
color: #6666ff; }
a:visited {
color: #800080; }
a:visited:hover {
color: #BB00BB; }
a[href^="http:"] {
text-decoration: underline; }
a[href^="https:"] {
text-decoration: underline; }

code > span.kw { color: #555; font-weight: bold; } 
code > span.dt { color: #902000; } 
code > span.dv { color: #40a070; } 
code > span.bn { color: #d14; } 
code > span.fl { color: #d14; } 
code > span.ch { color: #d14; } 
code > span.st { color: #d14; } 
code > span.co { color: #888888; font-style: italic; } 
code > span.ot { color: #007020; } 
code > span.al { color: #ff0000; font-weight: bold; } 
code > span.fu { color: #900; font-weight: bold; } 
code > span.er { color: #a61717; background-color: #e3d2d2; } 
</style>




</head>

<body>




<h1 class="title toc-ignore">Ascertaining UK Biobank diagnoses</h1>



<p>The goal of ukbrapR (phonetically: “U-K-B-wrapper”’“) is to make
ascertaining diagnoses in UK Biobank Electronic Medical Records (EMR)
simple and reproducible. It takes just a couple of minutes to go from a
list of diagnostic codes, to variables containing the”date first
diagnosed, any source.”</p>
<p>This is simplest is you are using the UK Biobank Research Analysis
Platform (RAP) on DNAnexus, but the functions work just as well using
local servers if you have the raw data saved as text files.</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" tabindex="-1"></a><span class="co"># First, load the package</span></span>
<span id="cb1-2"><a href="#cb1-2" tabindex="-1"></a><span class="fu">library</span>(ukbrapR)</span></code></pre></div>
<div id="list-of-diagnostic-codes" class="section level1">
<h1>List of diagnostic codes</h1>
<p>The outputted data is only ever as good as the diagnostic codes you
provide. The UK Biobank has a number of quirks to be aware of. If you’re
not already familiar with the documentation (<a href="https://biobank.ctsu.ox.ac.uk/crystal/label.cgi?id=100091" class="uri">https://biobank.ctsu.ox.ac.uk/crystal/label.cgi?id=100091</a>)
this is recommended.</p>
<p>Create a data frame containing the diagnostic codes. At minimum it
needs two variables: <code>codes</code> and <code>vocab_id</code> but a
third is recommended <code>condition</code>. Here, we will use codes for
haemochromatosis.</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" tabindex="-1"></a>codes_df_hh[<span class="dv">1</span><span class="sc">:</span><span class="dv">10</span>,]</span></code></pre></div>
<pre><code>##    condition      vocab_id  code
## 1         hh ukb_noncancer  1507
## 2         hh         ICD10 E83.1
## 3         hh         Read2 126A.
## 4         hh         Read2 4L41.
## 5         hh         Read2 677C0
## 6         hh         Read2 C350.
## 7         hh         Read2 C3500
## 8         hh          CTV3 C3500
## 9         hh          CTV3 X40QQ
## 10        hh          CTV3 XaIyI</code></pre>
<p>This data frame can contain codes for multiple conditions if desired.
Indicate where the codes belong using the <code>condition</code>
field.</p>
</div>
<div id="ascertain-emr-data-for-all-codes-in-codes_df" class="section level1">
<h1>Ascertain EMR data for all codes in <code>codes_df</code></h1>
<p>This function searches the GP, HES, and mortality data for all codes
in the provided data frame.</p>
<p>The “long” data is returned as a list containing the subset of
<code>gp_clinical</code>, <code>hesin_diag</code> and
<code>death_cause</code> with matched codes.</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" tabindex="-1"></a><span class="co"># If running on the RAP:</span></span>
<span id="cb4-2"><a href="#cb4-2" tabindex="-1"></a>diagnosis_list <span class="ot">&lt;-</span> <span class="fu">get_emr</span>(codes_df_hh)</span>
<span id="cb4-3"><a href="#cb4-3" tabindex="-1"></a><span class="co">#&gt; 7 ICD10 codes, 40 Read2 codes, 37 CTV3 codes </span></span>
<span id="cb4-4"><a href="#cb4-4" tabindex="-1"></a><span class="co">#&gt; 298.18 sec elapsed</span></span></code></pre></div>
<p>If running on your own server, use this function and provide paths to
the files. Note: if you are in my group and using servers
<code>indy</code>, <code>shpater</code> or <code>snow</code> you do not
need to provide the paths</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" tabindex="-1"></a>diagnosis_list <span class="ot">&lt;-</span> <span class="fu">get_emr_local</span>(codes_df_hh)</span></code></pre></div>
<pre><code>##  - N unique ICD10 codes: 1 
##  - N unique Read2 codes: 5 
##  - N unique CTV3 codes: 8
## ℹ Ascertaining cause of death data.
## ✔ Loaded `death_cause` with 42 matched rows.
## ℹ Ascertaining HES data.
## ✔ Loaded `hesin_diag` with 32697 matched rows.
## ℹ Ascertaining GP data (can take a few minutes).
## ✔ Loaded `gp_clinical` with 1441 matched rows.
## ✔ Finished. Time taken: 27.9s.</code></pre>
</div>
<div id="determine-the-date-first-diagnosed" class="section level1">
<h1>Determine the date first diagnosed</h1>
<p>Identify the date first diagnosed for each participant from any of
the “long” datasets ascertained above.</p>
<div class="sourceCode" id="cb16"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1" tabindex="-1"></a><span class="co"># for each participant, get Date First diagnosed with the condition</span></span>
<span id="cb16-2"><a href="#cb16-2" tabindex="-1"></a>diagnosis_df <span class="ot">&lt;-</span> <span class="fu">get_df</span>(diagnosis_list)</span>
<span id="cb16-3"><a href="#cb16-3" tabindex="-1"></a><span class="co">#&gt; takes &lt;1 second</span></span></code></pre></div>
<p>By default the <code>date first</code> fields is simply “df” - you
can add a variable prefix like:</p>
<div class="sourceCode" id="cb17"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1" tabindex="-1"></a>diagnosis_df <span class="ot">&lt;-</span> <span class="fu">get_df</span>(diagnosis_list, <span class="at">prefix=</span><span class="st">&quot;hh&quot;</span>)</span></code></pre></div>
<pre><code>## ✔ Identified date of first diagnosis from any source for 1976 participants.</code></pre>
<p>The function produces 5 variables for each condition. For
haemochromatosis, as ran above, these are:</p>
<table>
<thead>
<tr class="header">
<th>Field</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>hh_gp_df</td>
<td>Date first diagnosed in GP data</td>
</tr>
<tr class="even">
<td>hh_hes_df</td>
<td>Date first diagnosed in HES data</td>
</tr>
<tr class="odd">
<td>hh_death_df</td>
<td>Date first diagnosed in death data</td>
</tr>
<tr class="even">
<td>hh_df</td>
<td>Date first diagnosed from any source</td>
</tr>
<tr class="odd">
<td>hh_src</td>
<td>Source of combined date first</td>
</tr>
</tbody>
</table>
<div class="sourceCode" id="cb20"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1" tabindex="-1"></a>skimr<span class="sc">::</span><span class="fu">skim</span>(diagnosis_df)</span></code></pre></div>
<table>
<caption>Data summary</caption>
<tbody>
<tr class="odd">
<td align="left">Name</td>
<td align="left">diagnosis_df</td>
</tr>
<tr class="even">
<td align="left">Number of rows</td>
<td align="left">1976</td>
</tr>
<tr class="odd">
<td align="left">Number of columns</td>
<td align="left">6</td>
</tr>
</tbody>
</table>
<p><strong>Variable type: character</strong></p>
<table>
<colgroup>
<col width="19%" />
<col width="13%" />
<col width="19%" />
<col width="5%" />
<col width="5%" />
<col width="8%" />
<col width="12%" />
<col width="15%" />
</colgroup>
<thead>
<tr class="header">
<th align="left">skim_variable</th>
<th align="right">n_missing</th>
<th align="right">complete_rate</th>
<th align="right">min</th>
<th align="right">max</th>
<th align="right">empty</th>
<th align="right">n_unique</th>
<th align="right">whitespace</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">hh_src</td>
<td align="right">0</td>
<td align="right">1</td>
<td align="right">2</td>
<td align="right">5</td>
<td align="right">0</td>
<td align="right">3</td>
<td align="right">0</td>
</tr>
</tbody>
</table>
<p><strong>Variable type: Date</strong></p>
<table>
<colgroup>
<col width="17%" />
<col width="12%" />
<col width="17%" />
<col width="13%" />
<col width="13%" />
<col width="13%" />
<col width="11%" />
</colgroup>
<thead>
<tr class="header">
<th align="left">skim_variable</th>
<th align="right">n_missing</th>
<th align="right">complete_rate</th>
<th align="left">min</th>
<th align="left">max</th>
<th align="left">median</th>
<th align="right">n_unique</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">hh_gp_df</td>
<td align="right">1176</td>
<td align="right">0.40</td>
<td align="left">1968-05-01</td>
<td align="left">2017-08-14</td>
<td align="left">2011-02-07</td>
<td align="right">722</td>
</tr>
<tr class="even">
<td align="left">hh_hes_df</td>
<td align="right">484</td>
<td align="right">0.76</td>
<td align="left">1995-03-31</td>
<td align="left">2022-10-25</td>
<td align="left">2014-11-08</td>
<td align="right">1317</td>
</tr>
<tr class="odd">
<td align="left">hh_death_df</td>
<td align="right">1934</td>
<td align="right">0.02</td>
<td align="left">2010-07-22</td>
<td align="left">2022-09-13</td>
<td align="left">2017-05-31</td>
<td align="right">41</td>
</tr>
<tr class="even">
<td align="left">hh_df</td>
<td align="right">0</td>
<td align="right">1.00</td>
<td align="left">1968-05-01</td>
<td align="left">2022-10-25</td>
<td align="left">2013-04-09</td>
<td align="right">1651</td>
</tr>
</tbody>
</table>
<div class="sourceCode" id="cb21"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb21-1"><a href="#cb21-1" tabindex="-1"></a><span class="fu">table</span>(diagnosis_df<span class="sc">$</span>hh_src)</span></code></pre></div>
<pre><code>## 
## death    gp   hes 
##     3   739  1234</code></pre>
<div id="ascertaining-multiple-conditions-at-once" class="section level2">
<h2>Ascertaining multiple conditions at once</h2>
<p>By default <code>get_df()</code> will use all provided data. If you
searched for codes for multiple conditions at once and want to identify
the date first for each one, indicate this using
<code>group_by=&quot;condition&quot;</code> (assuming the field was called
“condition”).</p>
<div class="sourceCode" id="cb23"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb23-1"><a href="#cb23-1" tabindex="-1"></a><span class="co"># combine haemochromatosis and CKD codes together</span></span>
<span id="cb23-2"><a href="#cb23-2" tabindex="-1"></a>codes_df_combined <span class="ot">=</span> <span class="fu">rbind</span>(codes_df_hh, codes_df_ckd)</span>
<span id="cb23-3"><a href="#cb23-3" tabindex="-1"></a></span>
<span id="cb23-4"><a href="#cb23-4" tabindex="-1"></a><span class="co"># get diagnosis data - returns list of data frames (one per source)</span></span>
<span id="cb23-5"><a href="#cb23-5" tabindex="-1"></a>diagnosis_list <span class="ot">&lt;-</span> <span class="fu">get_emr</span>(codes_df_combined)</span>
<span id="cb23-6"><a href="#cb23-6" tabindex="-1"></a></span>
<span id="cb23-7"><a href="#cb23-7" tabindex="-1"></a><span class="co"># for each participant, get Date First diagnosed with the condition</span></span>
<span id="cb23-8"><a href="#cb23-8" tabindex="-1"></a>diagnosis_df <span class="ot">=</span> <span class="fu">get_df</span>(diagnosis_list, <span class="at">group_by=</span><span class="st">&quot;condition&quot;</span>)</span></code></pre></div>
</div>
</div>



<!-- code folding -->


<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

</body>
</html>
