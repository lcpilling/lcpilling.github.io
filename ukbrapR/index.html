<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="description" content="R functions to use in the UK Biobank Research Analysis Platform (RAP). Not comprehensive, but designed to make some working on the RAP easier. Some shamelessly borrowed from other packages and the internet generally.">
<title>R functions to use in the UK Biobank Research Analysis Platform (RAP) • ukbrapR</title>
<script src="deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="deps/bootstrap-5.2.2/bootstrap.min.css" rel="stylesheet">
<script src="deps/bootstrap-5.2.2/bootstrap.bundle.min.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- bootstrap-toc --><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@v1.0.1/dist/bootstrap-toc.min.js" integrity="sha256-4veVQbu7//Lk5TSmc7YV48MxtMy98e26cf5MrgZYnwo=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- search --><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- pkgdown --><script src="pkgdown.js"></script><meta property="og:title" content="R functions to use in the UK Biobank Research Analysis Platform (RAP)">
<meta property="og:description" content="R functions to use in the UK Biobank Research Analysis Platform (RAP). Not comprehensive, but designed to make some working on the RAP easier. Some shamelessly borrowed from other packages and the internet generally.">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>
    

    <nav class="navbar fixed-top navbar-light navbar-expand-lg bg-light"><div class="container">
    
    <a class="navbar-brand me-2" href="index.html">ukbrapR</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.1.6</small>

    
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item">
  <a class="nav-link" href="reference/index.html">Reference</a>
</li>
<li class="nav-item dropdown">
  <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown" role="button" aria-expanded="false" aria-haspopup="true" id="dropdown-articles">Articles</a>
  <div class="dropdown-menu" aria-labelledby="dropdown-articles">
    <a class="dropdown-item" href="articles/ascertain_diagnoses.html">Ascertaining UK Biobank diagnoses</a>
  </div>
</li>
<li class="nav-item">
  <a class="nav-link" href="news/index.html">Changelog</a>
</li>
      </ul>
<form class="form-inline my-2 my-lg-0" role="search">
        <input type="search" class="form-control me-sm-2" aria-label="Toggle navigation" name="search-input" data-search-index="search.json" id="search-input" placeholder="Search for" autocomplete="off">
</form>

      <ul class="navbar-nav">
<li class="nav-item">
  <a class="external-link nav-link" href="https://github.com/lcpilling/ukbrapR/" aria-label="github">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>

    
  </div>
</nav><div class="container template-home">
<div class="row">
  <main id="main" class="col-md-9"><div class="section level1">
<div class="page-header"><h1 id="ukbrapr-">ukbrapR <a href="https://lcpilling.github.io/ukbrapR/"><img src="reference/figures/ukbrapR.png" align="right" width="150"></a>
<a class="anchor" aria-label="anchor" href="#ukbrapr-"></a>
</h1></div>
<p>{ukbrapR} (phonetically: ‘U-K-B-wrapper’) is an R package for use in the UK Biobank Research Analysis Platform (RAP).</p>
<!-- badges: start -->

<p><sub>Wrapped server icon by DALL-E</sub></p>
<div class="section level2">
<h2 id="installation">Installation<a class="anchor" aria-label="anchor" href="#installation"></a>
</h2>
<p><strong>Some functions only work on <a href="https://ukbiobank.dnanexus.com" class="external-link">DNAnexus</a> in a UK Biobank project in JupyterLab on a Spark Cluster.</strong></p>
<p>In tools, launch a JupyterLab environment on a Spark Cluster. In R, install {ukbrapR}. This will install the necessary dependencies for interacting with Python, Apache Spark, and the Arrow C++ library.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">remotes</span><span class="fu">::</span><span class="fu"><a href="https://remotes.r-lib.org/reference/install_github.html" class="external-link">install_github</a></span><span class="op">(</span><span class="st">"lcpilling/ukbrapR"</span><span class="op">)</span>        <span class="co"># development version</span></span>
<span></span>
<span><span class="fu">remotes</span><span class="fu">::</span><span class="fu"><a href="https://remotes.r-lib.org/reference/install_github.html" class="external-link">install_github</a></span><span class="op">(</span><span class="st">"lcpilling/ukbrapR@v0.1.0"</span><span class="op">)</span> <span class="co"># specific release (see tags)</span></span></code></pre></div>
<p>I highly recommend saving a “snapshot” once all the packages are installed, and loading this when launching JupyterLab.</p>
</div>
<div class="section level2">
<h2 id="get-phenotype-data">Get phenotype data<a class="anchor" aria-label="anchor" href="#get-phenotype-data"></a>
</h2>
<p><strong>Pull phenotypes from Apache Spark on DNAnexus to an R data frame.</strong> Recommend launching a Spark cluster with at least <code>mem1_hdd1_v2_x16</code> and <strong>2 nodes</strong> otherwise this can fail with error “…ensure that workers…have sufficient resources”</p>
<p>The underlying code is mostly from the <a href="https://github.com/UK-Biobank/UKB-RAP-Notebooks/blob/main/NBs_Prelim/105_export_participant_data_to_r.ipynb" class="external-link">UK Biobank GitHub</a>.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># get phenotype data (participant ID, sex, baseline age, and baseline assessment date)</span></span>
<span><span class="va">ukb</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/get_rap_phenos.html">get_rap_phenos</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"eid"</span>, <span class="st">"p31"</span>, <span class="st">"p21003_i0"</span>, <span class="st">"p53_i0"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; 48.02 sec elapsed</span></span>
<span></span>
<span><span class="co"># summary of data</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/table.html" class="external-link">table</a></span><span class="op">(</span><span class="va">ukb</span><span class="op">$</span><span class="va">p31</span><span class="op">)</span></span>
<span><span class="co">#&gt; Female   Male </span></span>
<span><span class="co">#&gt; 273297 229067</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">ukb</span><span class="op">$</span><span class="va">p21003_i0</span><span class="op">)</span></span>
<span><span class="co">#&gt;    Min. 1st Qu.  Median    Mean 3rd Qu.    Max. </span></span>
<span><span class="co">#&gt;  37.00   50.00   58.00   56.53   63.00   73.00 </span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="get-medical-records-diagnoses">Get medical records diagnoses<a class="anchor" aria-label="anchor" href="#get-medical-records-diagnoses"></a>
</h2>
<p>For a given set of diagnostic codes (ICD10, Read2, CTV3) get the participant Electronic Medical Records (EMR) data. Returns a list containing 3 data frames in “long” format (&gt;1 row per participant): the subset of <code>gp_clinical</code>, <code>hesin_diag</code> and <code>death_cause</code> with matched codes. <strong>Default behaviour is to use Apache Spark on DNAnexus. But if you have <code>gp_clinical</code> and <code>hesin</code> text files exported you can provide these to the <code>file_paths</code> option and run on any cluster/server.</strong></p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># example diagnostic codes for CKD from GEMINI multimorbidity project are included</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">codes_df_ckd</span><span class="op">)</span></span>
<span><span class="co">#&gt;   condition vocab_id  code</span></span>
<span><span class="co">#&gt; 1       ckd    ICD10 N18.3</span></span>
<span><span class="co">#&gt; 2       ckd    ICD10 N18.4</span></span>
<span><span class="co">#&gt; 3       ckd    ICD10 N18.5</span></span>
<span><span class="co">#&gt; 4       ckd    ICD10 N18.6</span></span>
<span><span class="co">#&gt; 5       ckd    ICD10 N18.9</span></span>
<span><span class="co">#&gt; 6       ckd    ICD10   N19</span></span>
<span></span>
<span><span class="co"># get diagnosis data - returns list of data frames (one per source)</span></span>
<span><span class="va">diagnosis_list</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/get_emr.html">get_emr</a></span><span class="op">(</span><span class="va">codes_df_ckd</span><span class="op">)</span> </span>
<span><span class="co">#&gt; 7 ICD10 codes, 40 Read2 codes, 37 CTV3 codes </span></span>
<span><span class="co">#&gt; 298.18 sec elapsed</span></span>
<span></span>
<span><span class="co"># N records for each source</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">diagnosis_list</span><span class="op">$</span><span class="va">gp_clinical</span><span class="op">)</span>  <span class="co">#  29,088</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">diagnosis_list</span><span class="op">$</span><span class="va">hesin_diag</span><span class="op">)</span>   <span class="co"># 206,394</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">diagnosis_list</span><span class="op">$</span><span class="va">death_cause</span><span class="op">)</span>  <span class="co">#   1,962</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="get-date-first-diagnosis">Get date first diagnosis<a class="anchor" aria-label="anchor" href="#get-date-first-diagnosis"></a>
</h2>
<p>Identify the date first diagnosed for each participant from any of the “long” datasets ascertained from <code><a href="reference/get_emr.html">get_emr()</a></code> (cause of death, HES, and GP).</p>
<p>Also includes a column indicating the source of the date of first diagnosis (gp, hes, death [or self-reported, if provided]).</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># for each participant, get Date First diagnosed with the condition</span></span>
<span><span class="va">diagnosis_df</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/get_df.html">get_df</a></span><span class="op">(</span><span class="va">diagnosis_list</span><span class="op">)</span></span>
<span><span class="co">#&gt; 0.98 sec elapsed</span></span>
<span></span>
<span><span class="co"># skim data </span></span>
<span><span class="fu">skimr</span><span class="fu">::</span><span class="fu"><a href="https://docs.ropensci.org/skimr/reference/skim.html" class="external-link">skim</a></span><span class="op">(</span><span class="va">diagnosis_df</span><span class="op">)</span></span>
<span><span class="co">#&gt; ── Data Summary ────────────────────────</span></span>
<span><span class="co">#&gt;                            Values      </span></span>
<span><span class="co">#&gt; Name                       diagnosis_df</span></span>
<span><span class="co">#&gt; Number of rows             31945       </span></span>
<span><span class="co">#&gt; Number of columns          5           </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; ── Variable type: character ────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────</span></span>
<span><span class="co">#&gt;   skim_variable n_missing complete_rate min max empty n_unique whitespace</span></span>
<span><span class="co">#&gt; 1 src                   0             1   2   5     0        3          0</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; ── Variable type: Date ─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────</span></span>
<span><span class="co">#&gt;   skim_variable n_missing complete_rate min        max        median     n_unique</span></span>
<span><span class="co">#&gt; 1 gp_df             18933        0.402  1958-01-01 2017-09-06 2009-09-15     3264</span></span>
<span><span class="co">#&gt; 2 hes_df             7487        0.764  1995-08-29 2022-10-31 2018-04-24     5560</span></span>
<span><span class="co">#&gt; 3 death_df          29756        0.0608 2008-02-20 2022-12-15 2020-03-03     1429</span></span>
<span><span class="co">#&gt; 4 df                    0        1      1958-01-01 2022-12-01 2015-01-22     6366</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="ascertaining-multiple-conditions-at-once">Ascertaining multiple conditions at once<a class="anchor" aria-label="anchor" href="#ascertaining-multiple-conditions-at-once"></a>
</h2>
<p>The most time-efficient way to do this is to run <code><a href="reference/get_emr.html">get_emr()</a></code> once for codes matching all conditions you wish to ascertain, then get the “date first diagnosed” for each condition separately.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># combine haemochromatosis and CKD codes together</span></span>
<span><span class="co">#   each contain there columns: condition, vocab_id, and code</span></span>
<span><span class="co">#   where `condition` is either "hh" or "ckd" and will become the variable prefix</span></span>
<span><span class="va">codes_df_combined</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">rbind</a></span><span class="op">(</span><span class="va">codes_df_hh</span>, <span class="va">codes_df_ckd</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># get diagnosis data - returns list of data frames (one per source)</span></span>
<span><span class="va">diagnosis_list</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/get_emr.html">get_emr</a></span><span class="op">(</span><span class="va">codes_df_combined</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># for each participant, get Date First diagnosed with the condition</span></span>
<span><span class="va">diagnosis_df</span> <span class="op">=</span> <span class="fu"><a href="reference/get_df.html">get_df</a></span><span class="op">(</span><span class="va">diagnosis_list</span>, group_by<span class="op">=</span><span class="st">"condition"</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="identify-self-reported-illness--cancer">Identify self-reported illness / cancer<a class="anchor" aria-label="anchor" href="#identify-self-reported-illness--cancer"></a>
</h2>
<p>UK Biobank cancer (<a href="https://biobank.ctsu.ox.ac.uk/crystal/field.cgi?id=20001" class="external-link uri">https://biobank.ctsu.ox.ac.uk/crystal/field.cgi?id=20001</a>) and non-cancer (<a href="https://biobank.ctsu.ox.ac.uk/crystal/field.cgi?id=20002" class="external-link uri">https://biobank.ctsu.ox.ac.uk/crystal/field.cgi?id=20002</a>) illness codes can be included in the codes list:</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Example, for haemochromatosis:</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">codes_df_hh</span><span class="op">)</span></span>
<span><span class="co">#&gt;    condition      vocab_id   code</span></span>
<span><span class="co">#&gt; 1         hh ukb_noncancer   1507</span></span>
<span><span class="co">#&gt; 2         hh         ICD10  E83.1</span></span>
<span><span class="co">#&gt; 3         hh         Read2  126A.</span></span>
<span><span class="co">#&gt; ...</span></span></code></pre></div>
<p>The below function will by default pull the appropriate self-reported fields from <strong>the DNAnexus Apache Spark</strong> system to determine whether a participant has reported any of the provided codes, and identify the self-reported date of diagnosis:</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">selfrep_df</span> <span class="op">=</span> <span class="fu"><a href="reference/get_selfrep_illness.html">get_selfrep_illness</a></span><span class="op">(</span><span class="va">codes_df</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/table.html" class="external-link">table</a></span><span class="op">(</span><span class="va">selfrep_df</span><span class="op">$</span><span class="va">selfrep</span><span class="op">)</span></span>
<span><span class="co">#&gt;     0      1 </span></span>
<span><span class="co">#&gt; 502099    170 </span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">selfrep_df</span><span class="op">$</span><span class="va">selfrep_df</span><span class="op">)</span></span>
<span><span class="co">#&gt;         Min.      1st Qu.       Median         Mean      3rd Qu.         Max.         NA's </span></span>
<span><span class="co">#&gt; "1941-11-25" "2003-07-02" "2007-07-02" "2006-06-26" "2011-07-02" "2022-07-02"     "502100" </span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/table.html" class="external-link">table</a></span><span class="op">(</span><span class="va">selfrep_df</span><span class="op">$</span><span class="va">selfrep_i</span><span class="op">)</span></span>
<span><span class="co">#&gt;  0  1  2  3 </span></span>
<span><span class="co">#&gt; 86 16 65  3 </span></span></code></pre></div>
<p>This can add quite a bit of time. If you prefer to use an already-extracted file (this therefore does not require a DNAnexus Spark cluster) you can:</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">selfrep_df</span> <span class="op">=</span> <span class="fu"><a href="reference/get_selfrep_illness.html">get_selfrep_illness</a></span><span class="op">(</span><span class="va">codes_df</span>, ukb_dat <span class="op">=</span> <span class="va">ukb_dat</span><span class="op">)</span></span></code></pre></div>
<p>You can add this data to the diagnosis list object to get an overall date first (self-reported plus medical records):</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">diagnosis_list</span>              <span class="op">&lt;-</span> <span class="fu"><a href="reference/get_emr.html">get_emr</a></span><span class="op">(</span><span class="va">codes_df_hh</span><span class="op">)</span></span>
<span><span class="va">selfrep_df</span>                  <span class="op">&lt;-</span> <span class="fu"><a href="reference/get_selfrep_illness.html">get_selfrep_illness</a></span><span class="op">(</span><span class="va">codes_df_hh</span><span class="op">)</span></span>
<span><span class="va">diagnosis_list</span><span class="op">[[</span><span class="st">"selfrep"</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">selfrep_df</span></span>
<span><span class="va">diagnosis_df</span>                <span class="op">&lt;-</span> <span class="fu"><a href="reference/get_df.html">get_df</a></span><span class="op">(</span><span class="va">diagnosis_list</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="example-analysis">Example analysis<a class="anchor" aria-label="anchor" href="#example-analysis"></a>
</h2>
<p>Hypothesis: baseline age and sex are associated with risk of incident CKD diagnosis in the medical record follow-up</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># get phenotype data (participant ID, sex, baseline age, and baseline assessment date)</span></span>
<span><span class="va">ukb</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/get_rap_phenos.html">get_rap_phenos</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"eid"</span>, <span class="st">"p31"</span>, <span class="st">"p21003_i0"</span>, <span class="st">"p53_i0"</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># ascertain CKD diagnoses and determine date first diagnosed, any source:</span></span>
<span><span class="va">diagnosis_list</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/get_emr.html">get_emr</a></span><span class="op">(</span><span class="va">codes_df_ckd</span><span class="op">)</span></span>
<span><span class="va">diagnosis_df</span>   <span class="op">&lt;-</span> <span class="fu"><a href="reference/get_df.html">get_df</a></span><span class="op">(</span><span class="va">diagnosis_list</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># merge phenotype data with ascertained diagnoses</span></span>
<span><span class="va">ukb</span> <span class="op">&lt;-</span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html" class="external-link">left_join</a></span><span class="op">(</span><span class="va">ukb</span>, <span class="va">diagnosis_df</span>, by<span class="op">=</span><span class="st">"eid"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># create binary "ever diagnosed" variable and </span></span>
<span><span class="co"># time-to-event from baseline (incident only) (or time to censoring, if no diagnosis)</span></span>
<span><span class="va">ukb</span> <span class="op">&lt;-</span> <span class="va">ukb</span> <span class="op">|&gt;</span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span></span>
<span>    CKD_bin  <span class="op">=</span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/if_else.html" class="external-link">if_else</a></span><span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">df</span><span class="op">)</span>, <span class="fl">1</span>, <span class="fl">0</span><span class="op">)</span>,</span>
<span>    CKD_time <span class="op">=</span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/case_when.html" class="external-link">case_when</a></span><span class="op">(</span></span>
<span>        <span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">df</span><span class="op">)</span> <span class="op">&amp;</span> <span class="va">df</span> <span class="op">&gt;</span> <span class="va">p53_i0</span> <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="va">df</span> <span class="op">-</span> <span class="va">p53_i0</span><span class="op">)</span><span class="op">/</span><span class="fl">365.25</span>,</span>
<span>        <span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">df</span><span class="op">)</span> <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="fu">lubridate</span><span class="fu">::</span><span class="fu"><a href="https://lubridate.tidyverse.org/reference/ymd.html" class="external-link">dmy</a></span><span class="op">(</span><span class="st">"31-10-2022"</span><span class="op">)</span> <span class="op">-</span> <span class="va">p53_i0</span><span class="op">)</span><span class="op">/</span><span class="fl">365.25</span>,</span>
<span>        <span class="cn">TRUE</span> <span class="op">~</span> <span class="cn">NA</span></span>
<span>    <span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/table.html" class="external-link">table</a></span><span class="op">(</span><span class="va">ukb</span><span class="op">$</span><span class="va">CKD_bin</span><span class="op">)</span></span>
<span><span class="co">#&gt;      0      1 </span></span>
<span><span class="co">#&gt; 470425  31939 </span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">ukb</span><span class="op">$</span><span class="va">CKD_time</span><span class="op">[</span> <span class="va">ukb</span><span class="op">$</span><span class="va">CKD_bin</span><span class="op">==</span><span class="fl">1</span> <span class="op">]</span><span class="op">)</span></span>
<span><span class="co">#&gt;   Min. 1st Qu.  Median    Mean 3rd Qu.    Max.    NA's </span></span>
<span><span class="co">#&gt;  0.003   4.427   7.863   7.694  11.244  16.512    6607 </span></span>
<span></span>
<span><span class="co"># fit time to event CoxPH model </span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/therneau/survival" class="external-link">survival</a></span><span class="op">)</span></span>
<span><span class="va">fit_CKD_coxph</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/survival/man/coxph.html" class="external-link">coxph</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/survival/man/Surv.html" class="external-link">Surv</a></span><span class="op">(</span><span class="va">CKD_time</span>, <span class="va">CKD_bin</span><span class="op">)</span> <span class="op">~</span> <span class="va">p21003_i0</span> <span class="op">+</span> <span class="va">p31</span>, data <span class="op">=</span> <span class="va">ukb</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># get tidy model output with 95% CIs and extreme p-values</span></span>
<span><span class="fu">lukesRlib</span><span class="fu">::</span><span class="fu"><a href="https://lcpilling.github.io/lukesRlib/reference/tidy_ci.html" class="external-link">tidy_ci</a></span><span class="op">(</span><span class="va">fit_CKD_coxph</span><span class="op">)</span></span>
<span><span class="co">#&gt; CoxPH model (estimate=Hazard Ratio) :: N=495757, Nevents=25332 :: C-statistic=0.71</span></span>
<span><span class="co">#&gt; # A tibble: 2 × 8</span></span>
<span><span class="co">#&gt;   term      estimate std.error statistic  p.value conf.low conf.high p.extreme </span></span>
<span><span class="co">#&gt;   &lt;chr&gt;        &lt;dbl&gt;     &lt;dbl&gt;     &lt;dbl&gt;    &lt;dbl&gt;    &lt;dbl&gt;     &lt;dbl&gt; &lt;chr&gt;     </span></span>
<span><span class="co">#&gt; 1 p21003_i0     1.12   0.00104     106.  0            1.11      1.12 2.22e-2462</span></span>
<span><span class="co">#&gt; 2 p31Male       1.16   0.0126       11.8 3.27e-32     1.13      1.19 NA</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="upload-file-to-the-rap">Upload file to the RAP<a class="anchor" aria-label="anchor" href="#upload-file-to-the-rap"></a>
</h2>
<p>A wrapper to quickly upload a file from the worker node to the RAP space.</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># save phenotypes to a file and upload to current working directory</span></span>
<span><span class="fu">readr</span><span class="fu">::</span><span class="fu"><a href="https://readr.tidyverse.org/reference/write_delim.html" class="external-link">write_tsv</a></span><span class="op">(</span><span class="va">ukb</span>, <span class="st">"ukbrap.phenos.20231114.txt.gz"</span><span class="op">)</span></span>
<span><span class="fu"><a href="reference/upload_to_rap.html">upload_to_rap</a></span><span class="op">(</span><span class="st">"ukbrap.phenos.20231114.txt.gz"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># save "long" diagnosis data plus the derived "wide" date first and upload to directory "extracts"</span></span>
<span><span class="fu">readr</span><span class="fu">::</span><span class="fu"><a href="https://readr.tidyverse.org/reference/write_delim.html" class="external-link">write_tsv</a></span><span class="op">(</span><span class="va">diagnosis_list</span><span class="op">$</span><span class="va">death_cause</span>, <span class="st">"ukbrap.CKD.death_cause.20231114.txt.gz"</span><span class="op">)</span></span>
<span><span class="fu">readr</span><span class="fu">::</span><span class="fu"><a href="https://readr.tidyverse.org/reference/write_delim.html" class="external-link">write_tsv</a></span><span class="op">(</span><span class="va">diagnosis_list</span><span class="op">$</span><span class="va">hesin_diag</span>,  <span class="st">"ukbrap.CKD.hesin_diag.20231114.txt.gz"</span><span class="op">)</span></span>
<span><span class="fu">readr</span><span class="fu">::</span><span class="fu"><a href="https://readr.tidyverse.org/reference/write_delim.html" class="external-link">write_tsv</a></span><span class="op">(</span><span class="va">diagnosis_list</span><span class="op">$</span><span class="va">gp_clinical</span>, <span class="st">"ukbrap.CKD.gp_clinical.20231114.txt.gz"</span><span class="op">)</span></span>
<span><span class="fu">readr</span><span class="fu">::</span><span class="fu"><a href="https://readr.tidyverse.org/reference/write_delim.html" class="external-link">write_tsv</a></span><span class="op">(</span><span class="va">diagnosis_df</span>, <span class="st">"ukbrap.CKD.date_first.20231114.txt.gz"</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="reference/upload_to_rap.html">upload_to_rap</a></span><span class="op">(</span><span class="st">"ukbrap.*.20231114.txt.gz"</span>, dir<span class="op">=</span><span class="st">"extracts/"</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="benchmarking">Benchmarking<a class="anchor" aria-label="anchor" href="#benchmarking"></a>
</h2>
<p>On a DNAnexus Spark cluster: <code>mem1_hdd1_v2_x16</code> with <strong>2 nodes</strong> on “Normal” priority</p>
<table class="table">
<colgroup>
<col width="26%">
<col width="52%">
<col width="21%">
</colgroup>
<thead><tr class="header">
<th>Thing</th>
<th>Time taken</th>
<th>Note</th>
</tr></thead>
<tbody>
<tr class="odd">
<td>Launch JupyterLab Spark cluster</td>
<td>8 minutes</td>
<td></td>
</tr>
<tr class="even">
<td>Build R package plus dependencies</td>
<td>5 minutes</td>
<td>Can be skipped if using a saved Snapshot</td>
</tr>
<tr class="odd">
<td>Get phenotype data</td>
<td>1 minute</td>
<td></td>
</tr>
<tr class="even">
<td>Ascertain medical records diagnoses</td>
<td>5 minutes</td>
<td>Includes converting to wide “date first”</td>
</tr>
<tr class="odd">
<td>Simple analysis</td>
<td>&lt;1 minute</td>
<td></td>
</tr>
</tbody>
</table>
<p>Approx. time: 20 mins</p>
<p>Approx. cost: £0.20</p>
<p><em>Note: time can vary depending on number of phenotypes/diagnostic codes requested, and how busy the platform is.</em></p>
</div>
</div>
  </main><aside class="col-md-3"><div class="links">
<h2 data-toc-skip>Links</h2>
<ul class="list-unstyled">
<li><a href="https://github.com/lcpilling/ukbrapR/" class="external-link">Browse source code</a></li>
<li><a href="https://github.com/lcpilling/ukbrapR/issues" class="external-link">Report a bug</a></li>
</ul>
</div>

<div class="license">
<h2 data-toc-skip>License</h2>
<ul class="list-unstyled">
<li><a href="https://www.r-project.org/Licenses/GPL-3" class="external-link">GPL-3</a></li>
</ul>
</div>


<div class="citation">
<h2 data-toc-skip>Citation</h2>
<ul class="list-unstyled">
<li><a href="authors.html#citation">Citing ukbrapR</a></li>
</ul>
</div>

<div class="developers">
<h2 data-toc-skip>Developers</h2>
<ul class="list-unstyled">
<li>
<a href="https://lcpilling.github.io" class="external-link">Luke Pilling</a> <br><small class="roles"> Author, maintainer </small> <a href="https://orcid.org/0000-0002-3332-8454" target="orcid.widget" aria-label="ORCID" class="external-link"><span class="fab fa-orcid orcid" aria-hidden="true"></span></a> </li>
</ul>
</div>

<div class="dev-status">
<h2 data-toc-skip>Dev status</h2>
<ul class="list-unstyled">
<li><a href="https://github.com/lcpilling/ukbrapR" class="external-link"><img src="https://img.shields.io/badge/version-0.1.6-informational.svg"></a></li>
<li><a href="https://github.com/lcpilling/ukbrapR/commits/master" class="external-link"><img src="https://img.shields.io/github/last-commit/lcpilling/ukbrapR.svg"></a></li>
<li><a href="https://www.tidyverse.org/lifecycle/#experimental" class="external-link"><img src="https://img.shields.io/badge/lifecycle-experimental-orange"></a></li>
</ul>
</div>

  </aside>
</div>


    <footer><div class="pkgdown-footer-left">
  <p></p>
<p>Developed by <a href="https://lcpilling.github.io" class="external-link">Luke Pilling</a>.</p>
</div>

<div class="pkgdown-footer-right">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.7.</p>
</div>

    </footer>
</div>

  

  

  </body>
</html>
